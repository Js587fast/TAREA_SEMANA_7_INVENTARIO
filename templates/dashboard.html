{% extends "base.html" %}
{% block title %}Panel Principal - Inventario PYMES{% endblock %}
{% block content %}
{% set es_admin = (session.get('rol') == 'administrador') %}

<h1 class="mb-4">Bienvenido al Panel de Inventario üöÄ</h1>

{% if es_admin %}
<!-- ===================== HERRAMIENTAS ADMINISTRADOR ===================== -->
<div class="card p-3 shadow-sm mb-4" style="max-width: 800px;">
  <h5 class="mb-3">üõ†Ô∏è Herramientas de Administraci√≥n</h5>
  <div class="d-flex flex-wrap gap-2">
    <form action="{{ url_for('reportes.admin_recalcular_totales') }}" method="post" class="d-inline">
      <button class="btn btn-outline-primary">
        üîÑ Recalcular totales (ventas y detalles)
      </button>
    </form>
    <a href="{{ url_for('reportes.ver_auditoria') }}" class="btn btn-outline-dark">
      üìú Ver auditor√≠a
    </a>
  </div>
  <p class="text-muted small mt-2 mb-0">
    El rec√°lculo usa el precio actual del producto para recomputar cada <em>subtotal</em> y luego el <em>total</em> de cada venta.
  </p>
</div>
{% endif %}

<!-- ===================== REPORTES ===================== -->
<h2 class="mt-4"><i class="bi bi-file-earmark-bar-graph"></i> Reportes</h2>

<div class="d-flex flex-wrap gap-3 mb-4">
  <!-- Inventario -->
  <div class="card p-3 shadow-sm" style="width: 250px">
    <h5>Inventario</h5>
    <p class="text-muted small">Descarga en Excel o PDF</p>
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle w-100" data-bs-toggle="dropdown">Descargar</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_inventario') }}?formato=excel">Excel</a></li>
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_inventario') }}?formato=pdf">PDF</a></li>
      </ul>
    </div>
  </div>

  <!-- Ventas -->
  <div class="card p-3 shadow-sm" style="width: 250px">
    <h5>Ventas</h5>
    <p class="text-muted small">Descarga en Excel o PDF</p>
    <div class="dropdown">
      <button class="btn btn-success dropdown-toggle w-100" data-bs-toggle="dropdown">Descargar</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_ventas') }}?formato=excel">Excel</a></li>
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_ventas') }}?formato=pdf">PDF</a></li>
      </ul>
    </div>
  </div>

  <!-- Clientes -->
  <div class="card p-3 shadow-sm" style="width: 250px">
    <h5>Clientes</h5>
    <p class="text-muted small">Descarga en Excel o PDF</p>
    <div class="dropdown">
      <button class="btn btn-warning dropdown-toggle w-100" data-bs-toggle="dropdown">Descargar</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_clientes') }}?formato=excel">Excel</a></li>
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_clientes') }}?formato=pdf">PDF</a></li>
      </ul>
    </div>
  </div>

  <!-- Proveedores -->
  <div class="card p-3 shadow-sm" style="width: 250px">
    <h5>Proveedores</h5>
    <p class="text-muted small">Descarga en Excel o PDF</p>
    <div class="dropdown">
      <button class="btn btn-danger dropdown-toggle w-100" data-bs-toggle="dropdown">Descargar</button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_proveedores') }}?formato=excel">Excel</a></li>
        <li><a class="dropdown-item" href="{{ url_for('reportes.reporte_proveedores') }}?formato=pdf">PDF</a></li>
      </ul>
    </div>
  </div>
</div>

<!-- ===================== TIENDAS ===================== -->
<h2 class="mt-4"><i class="bi bi-shop"></i> Tiendas</h2>

{% if es_admin %}
<a href="{{ url_for('tienda.nueva_tienda') }}" class="btn btn-success mb-2">
  <i class="bi bi-plus-circle"></i> Agregar Tienda
</a>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Ubicaci√≥n</th>
        <th>Contacto</th>
        <th>Email</th>
        {% if es_admin %}<th>Acciones</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for t in tiendas %}
      <tr>
        <td>{{ t.id_tienda }}</td>
        <td>{{ t.nombre }}</td>
        <td>{{ t.ubicacion or "‚Äî" }}</td>
        <td>{{ t.contacto or "‚Äî" }}</td>
        <td>{{ t.email or "‚Äî" }}</td>
        {% if es_admin %}
        <td>
          <a href="{{ url_for('tienda.editar_tienda', id=t.id_tienda) }}" class="btn btn-primary btn-sm">
            <i class="bi bi-pencil-square"></i> Editar
          </a>
          <form action="{{ url_for('tienda.eliminar_tienda', id=t.id_tienda) }}" method="post" style="display: inline">
            <button class="btn btn-danger btn-sm" onclick="return confirm('‚ö†Ô∏è ¬øSeguro que deseas eliminar esta tienda?')">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </form>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if es_admin %}

<!-- ===================== PROVEEDORES ===================== -->
<h2 class="mt-4"><i class="bi bi-truck"></i> Proveedores</h2>
<a href="{{ url_for('proveedor.nuevo_proveedor') }}" class="btn btn-success mb-2">
  <i class="bi bi-plus-circle"></i> Agregar Proveedor
</a>
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Contacto</th>
        <th>Email</th>
        <th>Ubicaci√≥n</th> <!-- NUEVA COLUMNA -->
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in proveedores %}
      <tr>
        <td>{{ p.id_proveedor }}</td>
        <td>{{ p.nombre }}</td>
        <td>{{ p.contacto or "‚Äî" }}</td>
        <td>{{ p.email or "‚Äî" }}</td>
        <td>{{ p.ubicacion or "‚Äî" }}</td> <!-- NUEVA COLUMNA -->
        <td>
          <a href="{{ url_for('proveedor.editar_proveedor', id=p.id_proveedor) }}" class="btn btn-primary btn-sm">
            <i class="bi bi-pencil-square"></i> Editar
          </a>
          <form action="{{ url_for('proveedor.eliminar_proveedor', id=p.id_proveedor) }}" method="post" style="display: inline">
            <button class="btn btn-danger btn-sm" onclick="return confirm('‚ö†Ô∏è ¬øSeguro que deseas eliminar este proveedor?')">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===================== PRODUCTOS ===================== -->
<h2 class="mt-4"><i class="bi bi-box"></i> Productos</h2>
<a href="{{ url_for('producto.nuevo_producto') }}" class="btn btn-success mb-2">
  <i class="bi bi-plus-circle"></i> Agregar Producto
</a>
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-primary">
      <tr>
        <th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Proveedor</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for pr in productos %}
      <tr>
        <td>{{ pr.id_producto }}</td>
        <td>{{ pr.nombre }}</td>
        <td>{{ pr.precio|clp }}</td>
        <td>{{ pr.stock }}</td>
        <td>{{ pr.proveedor.nombre if pr.proveedor else "‚Äî" }}</td>
        <td>
          <a href="{{ url_for('producto.editar_producto', id=pr.id_producto) }}" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square"></i> Editar</a>
          <form action="{{ url_for('producto.eliminar_producto', id=pr.id_producto) }}" method="post" style="display: inline">
            <button class="btn btn-danger btn-sm" onclick="return confirm('‚ö†Ô∏è ¬øSeguro que deseas eliminar este producto?')"><i class="bi bi-trash"></i> Eliminar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===================== CLIENTES ===================== -->
<h2 class="mt-4"><i class="bi bi-people"></i> Clientes</h2>
<a href="{{ url_for('cliente.nuevo_cliente') }}" class="btn btn-success mb-2">
  <i class="bi bi-plus-circle"></i> Agregar Cliente
</a>
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-primary">
      <tr>
        <th>ID</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for c in clientes %}
      <tr>
        <td>{{ c.id_cliente }}</td>
        <td>{{ c.nombre }}</td>
        <td>{{ c.email }}</td>
        <td>{{ c.telefono }}</td>
        <td>
          <a href="{{ url_for('cliente.editar_cliente', id=c.id_cliente) }}" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square"></i> Editar</a>
          <form action="{{ url_for('cliente.eliminar_cliente', id=c.id_cliente) }}" method="post" style="display: inline">
            <button class="btn btn-danger btn-sm" onclick="return confirm('‚ö†Ô∏è ¬øSeguro que deseas eliminar este cliente?')"><i class="bi bi-trash"></i> Eliminar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===================== VENTAS ===================== -->
<h2 class="mt-4"><i class="bi bi-cart"></i> Ventas</h2>
<a href="{{ url_for('venta.nueva_venta') }}" class="btn btn-success mb-2"><i class="bi bi-plus-circle"></i> Agregar Venta</a>
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-primary">
      <tr>
        <th>ID</th><th>Fecha</th><th>Total</th><th>Cliente</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for v in ventas %}
      <tr>
        <td>{{ v.id_venta }}</td>
        <td>{{ v.fecha }}</td>
        <td>{{ v.total|clp }}</td>
        <td>{{ v.cliente.nombre if v.cliente else "‚Äî" }}</td>
        <td>
          <a href="{{ url_for('venta.editar_venta', id_venta=v.id_venta) }}" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square"></i> Editar</a>
          <form action="{{ url_for('venta.eliminar_venta', id_venta=v.id_venta) }}" method="post" style="display: inline">
            <button class="btn btn-danger btn-sm" onclick="return confirm('‚ö†Ô∏è ¬øSeguro que deseas eliminar esta venta?')"><i class="bi bi-trash"></i> Eliminar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ===================== DETALLES DE VENTAS ===================== -->
<h2 class="mt-4"><i class="bi bi-list-check"></i> Detalle de Ventas</h2>
<a href="{{ url_for('detalle.nuevo_detalle') }}" class="btn btn-success mb-2"><i class="bi bi-plus-circle"></i> Agregar Detalle</a>
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle text-center">
    <thead class="table-primary">
      <tr>
        <th>ID</th><th>Venta</th><th>Cliente</th><th>Tienda</th><th>Producto</th><th>Cantidad</th><th>Precio Unitario</th><th>Subtotal</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for d in detalleventas %}
      <tr>
        <td>{{ d.id_detalle }}</td>
        <td>{{ d.venta.id_venta }}</td>
        <td>{{ d.venta.cliente.nombre if d.venta and d.venta.cliente else "‚Äî" }}</td>
        <td>{{ d.venta.tienda.nombre if d.venta and d.venta.tienda else "‚Äî" }}</td>
        <td>{{ d.producto.nombre }}</td>
        <td>{{ d.cantidad }}</td>
        <td>
          {% if d.cantidad %}
            {{ (d.subtotal / d.cantidad)|clp }}
          {% else %}
            {{ 0|clp }}
          {% endif %}
        </td>
        <td>{{ d.subtotal|clp }}</td>
        <td>
          <a href="{{ url_for('detalle.editar_detalle', id_detalle=d.id_detalle) }}" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square"></i> Editar</a>
          <form action="{{ url_for('detalle.eliminar_detalle', id_detalle=d.id_detalle) }}" method="post" style="display: inline">
            <button class="btn btn-danger btn-sm" onclick="return confirm('‚ö†Ô∏è ¬øSeguro que deseas eliminar este detalle?')"><i class="bi bi-trash"></i> Eliminar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

{% endblock %}
