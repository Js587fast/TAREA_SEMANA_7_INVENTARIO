<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Detalle de Venta</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">Editar Detalle de Venta</h3>
    </div>
    <div class="card-body">
      <form method="POST" class="needs-validation" novalidate>

        <!-- Venta -->
        <div class="mb-3">
          <label for="id_venta" class="form-label">Venta</label>
          <select id="id_venta" name="id_venta" class="form-select" required>
            {% for v in ventas %}
              <option value="{{ v.id_venta }}" {% if v.id_venta == detalle.id_venta %}selected{% endif %}>
                ID {{ v.id_venta }} - {{ v.fecha }}
              </option>
            {% endfor %}
          </select>
          <div class="invalid-feedback">Selecciona una venta válida.</div>
        </div>

        <!-- Producto -->
        <div class="mb-3">
          <label for="id_producto" class="form-label">Producto</label>
          <select id="id_producto" name="id_producto" class="form-select" required>
            {% for pr in productos %}
              <!-- OBSERVACION: Se debe agregar el precio en data-precio -->
              <option value="{{ pr.id_producto }}" data-precio="{{ pr.precio }}" {% if pr.id_producto == detalle.id_producto %}selected{% endif %}>
                {{ pr.nombre }} (Precio: {{ pr.precio }})
              </option>
            {% endfor %}
          </select>
          <div class="invalid-feedback">Selecciona un producto válido.</div>
        </div>

        <!-- Cantidad -->
        <div class="mb-3">
          <label for="cantidad" class="form-label">Cantidad</label>
          <input type="number" id="cantidad" name="cantidad" class="form-control" value="{{ detalle.cantidad }}" min="1" required>
          <div class="invalid-feedback">Ingresa una cantidad válida (mínimo 1).</div>
        </div>

        <!-- Subtotal -->
        <div class="mb-3">
          <label for="subtotal_display" class="form-label">Subtotal</label>
          <!-- Campo solo visual -->
          <input type="text" id="subtotal_display" class="form-control" readonly>
          <!-- Campo oculto para enviar el número real al backend -->
          <input type="hidden" id="subtotal" name="subtotal" value="{{ detalle.subtotal }}">
          <div class="invalid-feedback">Ingresa un subtotal válido.</div>
        </div>

        <!-- Botones -->
        <div class="d-flex justify-content-between">
          <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">← Cancelar</a>
          <button type="submit" class="btn btn-success">✅ Actualizar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Validación de Bootstrap
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
})();

// Cálculo automático de subtotal con formato CLP
const productoSelect = document.getElementById('id_producto');
const cantidadInput = document.getElementById('cantidad');
const subtotalHidden = document.getElementById('subtotal');
const subtotalDisplay = document.getElementById('subtotal_display');

// Formateador CLP
const formatoCLP = new Intl.NumberFormat('es-CL', {
  style: 'currency',
  currency: 'CLP',
  minimumFractionDigits: 0
});

function calcularSubtotal() {
  const precio = parseFloat(productoSelect.selectedOptions[0].dataset.precio || 0);
  const cantidad = parseFloat(cantidadInput.value) || 0;
  const subtotal = precio * cantidad;

  // Campo oculto con valor real (sin formato)
  subtotalHidden.value = subtotal.toFixed(2);

  // Campo visible formateado en pesos 
  subtotalDisplay.value = formatoCLP.format(subtotal);
}

// Eventos para recalcular
productoSelect.addEventListener('change', calcularSubtotal);
cantidadInput.addEventListener('input', calcularSubtotal);

// Inicializa al cargar
document.addEventListener('DOMContentLoaded', calcularSubtotal);
</script>

</body>
</html>
