{% extends "base.html" %}
{% block title %}Auditor√≠a - Inventario PYMES{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="mb-0">üìú Auditor√≠a del sistema</h1>
  <div class="d-flex gap-2">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
      ‚Üê Volver
    </a>
    <a href="{{ url_for('reportes.descargar_auditoria_csv') }}" class="btn btn-outline-success">
      ‚¨áÔ∏è Exportar CSV
    </a>
  </div>
</div>

<!-- Filtro r√°pido en cliente -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-auto">
        <label for="filtro" class="col-form-label fw-semibold">Buscar:</label>
      </div>
      <div class="col-12 col-md-6">
        <input id="filtro" type="text" class="form-control" placeholder="Filtra por usuario, acci√≥n o detalles...">
      </div>
      <div class="col-12 col-md-auto">
        <button id="limpiar" class="btn btn-outline-secondary">Limpiar</button>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table id="tabla-auditoria" class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th style="white-space:nowrap;">#</th>
        <th style="white-space:nowrap;">Fecha/Hora</th>
        <th>Usuario</th>
        <th>Acci√≥n</th>
        <th>Detalles</th>
        <th style="white-space:nowrap;">IP</th>
      </tr>
    </thead>
    <tbody>
      {% for l in logs %}
      <tr>
        <td>{{ l.id_auditoria }}</td>
        <td>{{ l.fecha_hora }}</td>
        <td>
          {{ l.usuario_nombre or "‚Äî" }}
          <small class="text-muted">({{ l.usuario_id or "‚Äî" }})</small>
        </td>
        <td>
          <span class="badge bg-primary">{{ l.accion }}</span>
        </td>
        <td style="max-width: 560px;">
          <div class="small text-wrap" style="white-space: normal;">
            {{ l.detalles or "‚Äî" }}
          </div>
          {% if l.detalles_json %}
          <details class="mt-1">
            <summary class="small text-muted" style="cursor:pointer;">ver JSON</summary>
            <pre class="border rounded p-2 bg-light small mb-0" style="white-space: pre-wrap; word-break: break-word;">{{ l.detalles_json | tojson(indent=2) }}</pre>
          </details>
          {% endif %}
        </td>
        <td>{{ l.ip or "‚Äî" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // Filtro r√°pido de filas por texto
  (function () {
    const input = document.getElementById('filtro');
    const btnLimpiar = document.getElementById('limpiar');
    const tbody = document.querySelector('#tabla-auditoria tbody');

    function normalizar(str) {
      return (str || '').toString().toLowerCase();
    }

    function filtrar() {
      const q = normalizar(input.value);
      const filas = tbody.querySelectorAll('tr');
      filas.forEach(tr => {
        const t = normalizar(tr.innerText);
        tr.style.display = t.includes(q) ? '' : 'none';
      });
    }

    input.addEventListener('input', filtrar);
    btnLimpiar.addEventListener('click', function(){
      input.value = '';
      filtrar();
      input.focus();
    });
  })();
</script>
{% endblock %}
