{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white text-center">
      <h4>Registrar Nueva Venta</h4>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('venta.nueva_venta') }}">
        <!-- CLIENTE -->
        <div class="mb-3">
          <label for="id_cliente" class="form-label">Cliente:</label>
          <select name="id_cliente" id="id_cliente" class="form-select" required>
            <option value="">--Seleccionar--</option>
            {% for c in clientes %}
            <option value="{{ c.id_cliente }}">{{ c.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- FECHA -->
        <div class="mb-3">
          <label for="fecha" class="form-label">Fecha:</label>
          <input type="date" name="fecha" id="fecha" class="form-control">
        </div>

        <!-- TIENDA -->
        <div class="mb-3">
          <label for="id_tienda" class="form-label">Tienda:</label>
          <select name="id_tienda" id="id_tienda" class="form-select" required>
            <option value="">--Seleccionar--</option>
            {% for t in tiendas %}
            <option value="{{ t.id_tienda }}">{{ t.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- DETALLES DE PRODUCTOS -->
        <h5 class="text-secondary mb-3">Detalles de Productos</h5>
        <div id="productos-container">
          <div class="row mb-2 detalle-producto">
            <div class="col-md-5">
              <select name="detalles[0][id_producto]" class="form-select producto-select" required>
                <option value="">--Selecciona un producto--</option>
                {% for p in productos %}
                <option value="{{ p.id_producto }}"
                        data-precio="{{ p.precio }}"
                        data-stock="{{ p.stock }}">
                  {{ p.nombre }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <input type="number" min="1" name="detalles[0][cantidad]" class="form-control cantidad-input" placeholder="Cant." required>
            </div>
            <div class="col-md-3">
              <input type="number" step="0.01" min="0" name="detalles[0][precio_unitario]" class="form-control precio-input" placeholder="Precio" required>
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control stock-display" placeholder="Stock: -" disabled>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <button type="button" class="btn btn-secondary" id="add-producto">Agregar Otro Producto</button>
        </div>

        <div class="d-flex justify-content-between">
          <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-success">Guardar Venta</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Función para enlazar comportamiento a selects de producto
  function attachListeners(row) {
    const select = row.querySelector('.producto-select');
    const precioInput = row.querySelector('.precio-input');
    const stockDisplay = row.querySelector('.stock-display');
    select.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      const precio = selected.getAttribute('data-precio');
      const stock = selected.getAttribute('data-stock');
      if (precio) precioInput.value = precio;
      if (stock) stockDisplay.value = "Stock: " + stock;
    });
  }

  // Atachar al primer row
  document.querySelectorAll('.detalle-producto').forEach(attachListeners);

  // Botón que sirve para agregar otro producto
  document.getElementById('add-producto').addEventListener('click', function() {
    const container = document.getElementById('productos-container');
    const index = container.querySelectorAll('.detalle-producto').length;
    const newRow = container.firstElementChild.cloneNode(true);

    // limpiar valores
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    newRow.querySelector('select').selectedIndex = 0;

    // Se debe actualizar nombres de inputs para que no se repitan índices
    newRow.querySelectorAll('select, input').forEach(el => {
      if (el.name.includes('detalles')) {
        el.name = el.name.replace(/\d+/, index);
      }
    });

    container.appendChild(newRow);
    attachListeners(newRow);
  });
});
</script>
{% endblock %}
